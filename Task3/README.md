# Трейсинг
## Где заказ может сломаться или зависнуть:

1. Shop API -> CRM API -> MES API: при загрузке 3D-файла или отправке заказа возможна потеря сообщения в RabbitMQ или таймаут при расчёте.
2. MES API: долгая/неуспешная обработка 3D-модели c вычислением цены могут висеть в очереди по 30 минут.
3. MES API -> CRM API: задержка или потеря события из-за чего CRM API не видит заказа. Если сообщение потерялось, то заказ может застрять на последней стадии и вечно висеть.
4. CRM API -> MES API: Возможна потеря или двойная обработка подтверждения заказа.

### Список данных, которые должны попадать в трейсинг
Каждый заказ должен сопровождаться сквозным trace_id. Данные, которые собираем:
- TraceId: уникальный идентификатор сквозного запроса, который генерируется в Shop API при создании.
- SpanId: шаг внутри процесса (каждое взаимодействие сервисов генерирует отдельный span).
- OrderId: бизнес-ключ для связывания с заказом.
- Status: состояние заказа.
- Timestamps: время входа/выхода из каждого статуса.
- ServiceName: Shop API, MES Worker, CRM API и т. д.
- Errors: исключения, таймауты, повторные отправки.
- RabbitMQ metadata: queue, messageId.

## Мотивация
Почему нужен трейсинг:
- Видно, где теряются заказы
- SLA-метрики можно собирать автоматически
- Возможность давать партнёрам прозрачный отчёт (местоположение заказа, на какой он стадии)
- Отслеживание зависаний и потерь сообщений
- Снижение времени на устранение инцидента

## Предлагаемое решение
[Обновлённая схема С4](./jewerly_c4_model.drawio)

- OpenTelemetry для Shop и MES, CRM.
- OTel Collector для сбора трейсов.
- Jaeger для хранения и визуализации трейсов.
- Интеграция с RabbitMQ для передачи trace_id в заголовках сообщений.

- Jaeger интегрируются с Alertmanager. Если состояние заказа (например, время вычисления) больше обговорённых метрик по SLA, то создаётся алерт с оповещением в Jira и Telegram.

## Компромиссы
1. В проприетарный MES-код трейсинг сложно встроить
2. Большой объём трейсов хранить дорого, придётся делать семплирование
3. Проблемы с производительностью при избыточном логировании

## Безопасность
- Доступ к Jaeger/Tempo осуществлять только по VPN или через SSO
- Необходима роль Support только для просмотра трейсов, без админки
- Трейсинг не должен содержать никаких паспортов, телефонов
- Срок хранения данных о трассировках трейсов ограничить до 30 дней
