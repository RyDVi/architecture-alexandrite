# Архитектурное решение по логированию

## INFO логи

1. Сбор логов жизненного цикла заказа

- создание заказа
- загрузка 3D файла
- отправка заказа
- смена статуса заказа
- закрытие заказа

2. Логи расчёта заказа

- старт / конец расчёта
- успешный расчёт / ошибка расчёта

3. Логи доступа к системам при некорректных запросах или отсутствии прав доступа

4. Логи обработки заказа оператором

- Заказ принят на обработку
- Оператор взял заказ в работу
- Оператор закончил работу с заказом

5. Обработка сообщений из брокера

- Отправка заказа брокер
- Заказ обработан (сообщение из брокера)
- Ошибка обработки сообщения из брокера

<b>Дополнительно собирать:</b>

- DEBUG: локально и в release при расследовании инцидента.
- ERROR: техническая ошибка, приводящая к откату операции, запросы с кодами 5xx, DLQ и ошибки обработки сообщений.
- FATAL: сервис не запускается, нет коннекта к БД, миграции не применяются.

[Схема](./jewerly_c4_model.drawio)

## Мотивация

1. Уменьшение времение расследование инцидента
2. Контроль SLA и снижение просрочек. По логам смены статусов и событиям прайсинга можно автоматически вычислять t_PRICE, t_START и находить заказы, вышедшие за SLA — без ручных выгрузок.
3. Меньше нагрузки на поддержку и эскалаций. Поддержка сама видит причину (например, idempotency.conflict у партнёра или pricing.job_failed: timeout) и закрывает тикеты быстрее, не дергая разработчиков.
4. Прозрачность для партнёров и доверие
5. Предотвращение инцидентов

<b>Метрики:</b>

- уменьшение времени на исправление инцидента
- уменьшение количества заказов в зависшем состоянии
- уменьшение вовлеченности разработчиков в устранении инцидентов
- уменьшение количества просроченных заказов

<b>Что покрывать в первую очередь:</b>

1. CRM - через данную систему ведётся учёт и управление заказами. Поэтому требует более тщательного отслеживания действий пользователя и системы.
2. MES - данная система обрабатывает 3D модели, производит длительные расчёты. Поэтому требуется отслеживать не повис ли заказ / не отвалилась ли система.
3. Брокер очередей (RabbitMQ) - через него общаются системы с помощью сообщений, которые могут дублироваться / теряться.


## Предлагаемое решение
1. Из Shop, CRM, MES логи отправляются с использованием logstash и соответствующей библиотекой для работы с logstash, например, Logback + logstash-logback-encode.
2. Хранилище логов - Elasticsearch.
3. Grafana для поиска и отображения логов с дашбордами.


<b>Безопасность</b>

1. Все конфидициальные номера телефонов, почта и т.п. должны маскироваться на уровне приложения (например, phone=+7******1234, email=us***@mail.com).
2. При оплате на сайте банковские данные не должны логироваться, но информация об оплате должна записаться.
3. Логи заказов не должны отражать конфидициальные данные (например, адрес, ФИО). Вместо этого только идентификаторы.

| Кто            | Имеет доступ                                 |
|----------------|----------------------------------------------|
| DevOps         | Полный доступ                                |
| Продакт        | Дашборды                                     |
| Фронт, Бэк     | Логи ошибок, перфоманса, дашборды            |
| QA             | Логи ошибок, дашборды                        |
| Тимлид         | Логи ошибок, перфоманса, дашборды, метрики,  |
| Администраторы | Дашборды только с бизнес-метриками           |


<b>Индексы</b>
Под каждый сервис свой индекс для упрощения настройки и разграничения доступов, а также логи только для бизнеса (logs-shop-*, logs-crm-*, logs-mes-*, logs-infra-*, logs-business-*).

<b>Время хранения</b>
В проде информационные логи - 90 дней.
В проде логи ошибок - 180 дней.
Бизнес-логи - 1 год.
В dev окружениях - 14 дней


## Мероприятия для превращения системы сбора логов в систему анализа логов

Требуется алертинг и поиск аномалий. Для обработки и посика используется Alertmanager, Elasticsearch.

1. Если один человек оформил заказов больше, чем оформляют другие клиенты в среднем
2. Попытки DDOS
3. Множество 500 ошибок
4. Множество попыток неудачного входа
5. Отсутствие логов
6. Количество заказов не растёт (по условиям сервис каждый новый день получает заказов на 100 больше предыдущего). Если это не так, то следует выяснить причину, возможно пользователи не могут войти в систему или прерываются на каком-то этапе.


