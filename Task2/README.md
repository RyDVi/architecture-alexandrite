# Выбор и настройка мониторинга в системе

## Мотивация
1. Ранние предупреждения по расчёту цены/очередям и по доступности партнёрского API сокращают SLA-нарушения и неустойки. Меньше просрочек и потерь контрактов. 
2. Доступность и задержки API измеряются и декларируются — аргумент при продажах и удержании. Прозрачность для B2B-партнёров. 
3. Error budget и фактические SLO позволяют выпускать чаще и безопаснее. Ускорение релизов без страха
4. Видно, куда «утекает» время заказа (t_PRICE, t_START), — вкладываемся в самое «узкое» место. Приоритизация инвестиций.
5. Ежемесячный SLA-отчёт и воронка статусов — единая картина вместо субъективных ощущений. Объективные отчёты руководству. 

## Выбор подхода к мониторингу
Используем комбинированный подход под разные сервисы:
1. Для внешних API и пользовательских интерфейсов (Internet Shop, MES API, MES) будем использовать подход "четыре золотых сигнала" (Latency, Traffic, Errors, Saturation).
2. Для серверных компонентов и очередей (CRM, MES API, RabbitMQ-консьюмеры) будем использовать подход "RED" (Rate, Errors, Duration).
3. Для инфраструктуры (RabbitMQ, PostgreSQL, инстансы/контейнеры, S3) будем использовать подход "USE" (Utilization, Saturation, Errors).

## Используемые метрики
| Метрика                                                                     | Зачем                                                                                           | Ярлыки                          |
|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------|---------------------------------|
| Number of requests (RPS) for internet shop API / CRM API / MES API.         | Отслеживание объёма трафика и пиковых нагрузок                                                  | route, method, status_code, env |
| Number of requests (RPS) per user for internet shop API / CRM API / MES API | Обнаружение аномально большого трафика от партнёров и пользователей/партнёров                   | partner_id, user_id, route, env |
| Response time (latency) for shop/CRM/MES API                                | p95/p99 для SLO и алертов                                                                       | route, method, env              |
| Number of HTTP 200/500 for shop/CRM/MES API                                 | Отслеживание качества ответов для обнаружения проблем работы в приложении                       | route, env                      |
| Number of simultanious sessions for shop/CRM/MES API                        | Количество активных соединений/сессий для индикации нагрузки на API                             | service, env                    |
| Kb transferred/received / provided (sent) for shop/CRM/MES API              | Определение пропускной способности и узких мест сети                                            | service, env         |
| Number of dead-letter-exchange letters in RabbitMQ                          | Выявление некорректных сообщений и обнаружение массовых сбоев                                   | queue, env               |
| Number of message in flight in RabbitMQ                                     | Выявление медленных консьюмеров                                                                 | queue, env               |
| CPU % for shop/CRM/MES API                                                  | Обнаружение утечек CPU и триггер для увеличения инстансов при нагрузке                          | service, instance, env          |
| Memory Utilisation for shop/CRM/MES API                                     | Обнаружение утечек ОЗУ, предотвращение Out Of Memory, например, при обработке больших 3D файлов | service, instance, env          |
| Memory Utilisation for shop db instance / MES db instance                   | Отслеживание лимита памяти, предоставляемой для БД,                                             | db, role, env |
|                                                                             | для предотвращения использования дискового пространства вместо ОЗУ, что может увеличить latency |                                 |
| Number of connections for shop/MES db instance                              | Отслеживание утечек соединения с БД (например, какой-либо сервис не закрывает соединение)       | db,  env                  |
| Size of shop/MES db instance                                                | Отслеживания достатка памяти для хранения данных и расчёт бюжета под БД                         | db, env                         |
| Size of S3 storage                                                          | Отслеживания достатка памяти для хранения 3D и расчёт бюжета под 3D хранилище                   | bucket, env                     |


Пояснение к ярлыкам:
1. service - какой сервис сгенерирвал метрику
2. env - какое окружение (release, dev, prod)
3. instance - конкретный инстанс сервиса / БД
4. status_code - HTTP код ответа
5. method - HTTP метод
6. user_id / partner_id - ИД партнёра / клиента 
7. queue - наименование очереди
8. db - наименование инстанса БД
9. role - replica или master
10. bucket - наименование хранилища
11. route - url запроса


## План действий
1. Развернуть стек мониторинга: Prometheus + Grafana + OpenTelemetry.
2. Подключить Shop API / CRM  / MES к стеку для сбора метрик.
3. Подключить к брокеры очередей RabbitMQ, Shop DB, MES DB инструменты для экспорта метрик.
4. Добавить сервис для сбора бизнес-метрик.
5. Настроить дашборды для просмотра метрик.
6. Настроить оповещения (алерты) при достижении пороговых значений.
7. Написать инструкции по решению проблем при появлении алертов.
8. Поддержка и отслеживание метрик.


## Показатели насыщенности
1. При достижении нагрузки на CPU в течение 10 минут:
- Более 75% выдавать предупреждение;
- Более 85% критичный порог, добавлять дополнительные инстансы сервисов.

2. При достижении заполнения ОЗУ в течение 15 минут:
- Более 80% выдавать предупреждение;
- Более 90% рестарт сервисов, увеличить лимит на память, в случае регулярных заполнений памяти.